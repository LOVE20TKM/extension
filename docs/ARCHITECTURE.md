# LOVE20 Extension ç³»ç»Ÿæ¶æ„

## æ€»ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        LOVE20 Core System                            â”‚
â”‚  (Launch, Stake, Submit, Vote, Join, Verify, Mint, Random)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ ä¾èµ–
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Extension Center & Factory                         â”‚
â”‚         (ç®¡ç†æ‰©å±•çš„åˆ›å»ºã€æ³¨å†Œå’Œä¸æ ¸å¿ƒç³»ç»Ÿçš„äº¤äº’)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ åˆ›å»ºå’Œç®¡ç†
                         â†“

        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘         Extension ç»§æ‰¿å±‚æ¬¡ç»“æ„                 â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Level 1: Base Layer                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           ILOVE20Extension (Interface)                      â”‚   â”‚
â”‚  â”‚  - åŸºç¡€åŠŸèƒ½å®šä¹‰                                              â”‚   â”‚
â”‚  â”‚  - è´¦æˆ·ç®¡ç†æ¥å£                                              â”‚   â”‚
â”‚  â”‚  - å¥–åŠ±ç³»ç»Ÿæ¥å£                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                             â†“ å®ç°                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚        LOVE20ExtensionBase (Abstract Contract)              â”‚   â”‚
â”‚  â”‚  âœ… åˆå§‹åŒ–æœºåˆ¶                                               â”‚   â”‚
â”‚  â”‚  âœ… è´¦æˆ·ç®¡ç†å®ç° (_addAccount, _removeAccount)              â”‚   â”‚
â”‚  â”‚  âœ… å¥–åŠ±é¢†å–æµç¨‹ (claimReward)                               â”‚   â”‚
â”‚  â”‚  âš ï¸  å¾…å®ç°: rewardByAccount()                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ ç»§æ‰¿
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Level 2: Score Layer                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚      ILOVE20ExtensionAutoScore (Interface)                  â”‚   â”‚
â”‚  â”‚  - åˆ†æ•°è®¡ç®—æ¥å£                                              â”‚   â”‚
â”‚  â”‚  - å†å²åˆ†æ•°æŸ¥è¯¢æ¥å£                                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                             â†“ å®ç°                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚     LOVE20ExtensionAutoScore (Abstract Contract)            â”‚   â”‚
â”‚  â”‚  âœ… åˆ†æ•°å­˜å‚¨å’Œå¿«ç…§                                           â”‚   â”‚
â”‚  â”‚  âœ… å†å²åˆ†æ•°æŸ¥è¯¢                                             â”‚   â”‚
â”‚  â”‚  âœ… æ¯”ä¾‹å¥–åŠ±è®¡ç®— (rewardByAccount å®ç°)                      â”‚   â”‚
â”‚  â”‚  âœ… éªŒè¯ç»“æœç”Ÿæˆ (_prepareVerifyResultIfNeeded)             â”‚   â”‚
â”‚  â”‚  âš ï¸  å¾…å®ç°: calculateScores(), calculateScore()           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                 â”‚
                    â†“                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Level 3a: Join Layer    â”‚  â”‚ Level 3b: Stake Layer    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ IAutoScoreJoin   â”‚    â”‚  â”‚  â”‚ IAutoScoreStake  â”‚    â”‚
â”‚  â”‚ - Join æ¥å£      â”‚    â”‚  â”‚  â”‚ - Stake æ¥å£     â”‚    â”‚
â”‚  â”‚ - åŒºå—ç­‰å¾…æœŸ     â”‚    â”‚  â”‚  â”‚ - é˜¶æ®µç­‰å¾…æœŸ     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚           â†“ å®ç°          â”‚  â”‚           â†“ å®ç°          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚AutoScoreJoin     â”‚    â”‚  â”‚  â”‚AutoScoreStake    â”‚    â”‚
â”‚  â”‚âœ… Join/Withdraw  â”‚    â”‚  â”‚  â”‚âœ… Stake/Unstake  â”‚    â”‚
â”‚  â”‚âœ… åŒºå—ç­‰å¾…æœŸ     â”‚    â”‚  â”‚  â”‚âœ… Withdraw       â”‚    â”‚
â”‚  â”‚âœ… ä¸€æ¬¡æ€§è´¨æŠ¼     â”‚    â”‚  â”‚  â”‚âœ… é˜¶æ®µç­‰å¾…æœŸ     â”‚    â”‚
â”‚  â”‚âœ… æ²»ç†é—¨æ§›       â”‚    â”‚  â”‚  â”‚âœ… å¢é‡è´¨æŠ¼       â”‚    â”‚
â”‚  â”‚âš ï¸ å¾…å®ç°:        â”‚    â”‚  â”‚  â”‚âœ… æ²»ç†é—¨æ§›       â”‚    â”‚
â”‚  â”‚  è®¡ç®—åˆ†æ•°        â”‚    â”‚  â”‚  â”‚âš ï¸ å¾…å®ç°:        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚  â”‚  è®¡ç®—åˆ†æ•°        â”‚    â”‚
â”‚                          â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ•°æ®æµæ¶æ„

### ç”¨æˆ·å‚ä¸æµç¨‹

```
ç”¨æˆ·
 â”‚
 â”‚ 1. æ‰¹å‡†ä»£å¸
 â†“
ERC20 Token (Join/Stake)
 â”‚
 â”‚ 2. è°ƒç”¨ join/stake
 â†“
Extension Contract
 â”‚
 â”œâ”€â†’ 3a. æ£€æŸ¥æ²»ç†æŠ•ç¥¨ â”€â”€â”€â”€â†’ LOVE20 Stake Contract
 â”‚
 â”œâ”€â†’ 3b. è®°å½•å‚ä¸ä¿¡æ¯ â”€â”€â”€â”€â†’ å†…éƒ¨å­˜å‚¨ (_joinInfo / _stakeInfo)
 â”‚
 â”œâ”€â†’ 3c. æ·»åŠ åˆ°è´¦æˆ·åˆ—è¡¨ â”€â”€â†’ _accounts[]
 â”‚
 â””â”€â†’ 3d. æ³¨å†Œåˆ°ä¸­å¿ƒ â”€â”€â”€â”€â”€â”€â†’ Extension Center
```

### åˆ†æ•°è®¡ç®—æµç¨‹

```
Verify Phase å¼€å§‹
 â”‚
 â”‚ 1. _prepareVerifyResultIfNeeded()
 â†“
è°ƒç”¨ calculateScores()
 â”‚
 â”œâ”€â†’ è¯»å– _accounts[]
 â”‚
 â”œâ”€â†’ è¯»å–å‚ä¸ä¿¡æ¯ (_joinInfo / _stakeInfo)
 â”‚
 â””â”€â†’ è®¡ç®—æ¯ä¸ªè´¦æˆ·çš„åˆ†æ•°
     â”‚
     â†“
ç”Ÿæˆåˆ†æ•°å¿«ç…§
 â”‚
 â”œâ”€â†’ _totalScore[round]
 â”‚
 â”œâ”€â†’ _scores[round][]
 â”‚
 â”œâ”€â†’ _accountsByRound[round][]
 â”‚
 â””â”€â†’ _scoreByAccount[round][account]
```

### å¥–åŠ±åˆ†é…æµç¨‹

```
ç”¨æˆ·è°ƒç”¨ claimReward(round)
 â”‚
 â”‚ 1. æ£€æŸ¥è½®æ¬¡å·²ç»“æŸ
 â†“
_prepareRewardIfNeeded(round)
 â”‚
 â”œâ”€â†’ è°ƒç”¨ LOVE20 Mint â”€â†’ mintActionReward()
 â”‚
 â””â”€â†’ å­˜å‚¨ _reward[round]
     â”‚
     â†“
rewardByAccount(round, account)
 â”‚
 â”œâ”€â†’ è¯»å– _reward[round] (æ€»å¥–åŠ±)
 â”‚
 â”œâ”€â†’ è¯»å– _scoreByAccount[round][account] (ç”¨æˆ·åˆ†æ•°)
 â”‚
 â”œâ”€â†’ è¯»å– _totalScore[round] (æ€»åˆ†æ•°)
 â”‚
 â””â”€â†’ è®¡ç®—: reward = totalReward Ã— userScore / totalScore
     â”‚
     â†“
_claimReward(round)
 â”‚
 â”œâ”€â†’ æ ‡è®°å·²é¢†å– _claimedReward[round][account]
 â”‚
 â””â”€â†’ è½¬è´¦ä»£å¸ç»™ç”¨æˆ·
```

## æ¨¡å—èŒè´£çŸ©é˜µ

| æ¨¡å—          | åˆå§‹åŒ–  | è´¦æˆ·ç®¡ç† | å‚ä¸æœºåˆ¶ | åˆ†æ•°è®¡ç®—  | å¥–åŠ±åˆ†é… |
| ------------- | ------- | -------- | -------- | --------- | -------- |
| **Base**      | âœ… å®Œæ•´ | âœ… å®Œæ•´  | âŒ æ—     | âŒ æ—      | ğŸ”¶ æ¡†æ¶  |
| **AutoScore** | â†‘ ç»§æ‰¿  | â†‘ ç»§æ‰¿   | âŒ æ—     | ğŸ”¶ æ¡†æ¶   | âœ… å®Œæ•´  |
| **Join**      | â†‘ ç»§æ‰¿  | â†‘ ç»§æ‰¿   | âœ… å®Œæ•´  | ğŸ”¶ å¾…å®ç° | â†‘ ç»§æ‰¿   |
| **Stake**     | â†‘ ç»§æ‰¿  | â†‘ ç»§æ‰¿   | âœ… å®Œæ•´  | ğŸ”¶ å¾…å®ç° | â†‘ ç»§æ‰¿   |

**å›¾ä¾‹**ï¼š

- âœ… å®Œæ•´ï¼šæä¾›å®Œæ•´å®ç°
- ğŸ”¶ æ¡†æ¶/å¾…å®ç°ï¼šæä¾›æ¡†æ¶ï¼Œéœ€è¦å­ç±»å®ç°
- â†‘ ç»§æ‰¿ï¼šç›´æ¥ç»§æ‰¿çˆ¶ç±»å®ç°
- âŒ æ— ï¼šä¸æ¶‰åŠæ­¤åŠŸèƒ½

## ä¾èµ–å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  External Dependencies               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚  â”‚ OpenZeppelin     â”‚                               â”‚
â”‚  â”‚ - ERC20          â”‚                               â”‚
â”‚  â”‚ - IERC20         â”‚                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ ä½¿ç”¨
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  LOVE20 Core System                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚  Launch  Stake  Submit  Vote  Join  Verify  Mint    â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ æä¾›æœåŠ¡
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Extension Infrastructure                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚   Center     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”¤     Factory      â”‚     â”‚
â”‚  â”‚ (æ³¨å†Œç®¡ç†)   â”‚ ç®¡ç†    â”‚   (åˆ›å»ºæ‰©å±•)      â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ åˆ›å»ºå’Œåˆå§‹åŒ–
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Extension Implementations              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚  Base â†’ AutoScore â†’ Join / Stake                    â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å­˜å‚¨æ¶æ„

### Base Layer å­˜å‚¨

```solidity
// ä¸å¯å˜é…ç½®
factory: address
_launch, _stake, _submit, _vote: ILOVE20XXX
_join, _verify, _mint, _random: ILOVE20XXX

// å¯å˜çŠ¶æ€
tokenAddress: address
actionId: uint256
initialized: bool
_accounts: address[]
_reward: mapping(uint256 => uint256)
_claimedReward: mapping(uint256 => mapping(address => uint256))
```

### AutoScore Layer å­˜å‚¨

```solidity
// Base Layer å­˜å‚¨
// +

// åˆ†æ•°ç³»ç»Ÿ
_totalScore: mapping(uint256 => uint256)
_accountsByRound: mapping(uint256 => address[])
_scores: mapping(uint256 => uint256[])
_scoreByAccount: mapping(uint256 => mapping(address => uint256))
_verificationGenerated: mapping(uint256 => bool)
```

### Join Layer å­˜å‚¨

```solidity
// AutoScore Layer å­˜å‚¨
// +

// Join é…ç½®
joinTokenAddress: address (immutable)
waitingBlocks: uint256 (immutable)
minGovVotes: uint256 (immutable)

// Join çŠ¶æ€
totalJoinedAmount: uint256
_joinInfo: mapping(address => JoinInfo)
_joinToken: IERC20

struct JoinInfo {
    uint256 amount;
    uint256 joinedBlock;
}
```

### Stake Layer å­˜å‚¨

```solidity
// AutoScore Layer å­˜å‚¨
// +

// Stake é…ç½®
stakeTokenAddress: address (immutable)
waitingPhases: uint256 (immutable)
minGovVotes: uint256 (immutable)

// Stake çŠ¶æ€
totalStakedAmount: uint256
totalUnstakedAmount: uint256
_unstakers: address[]
_stakeInfo: mapping(address => StakeInfo)
_stakeToken: IERC20

struct StakeInfo {
    uint256 amount;
    uint256 requestedUnstakeRound;
}
```

## Gas ä¼˜åŒ–è®¾è®¡

### 1. ä¸å¯å˜å˜é‡

æ‰€æœ‰é…ç½®å‚æ•°ä½¿ç”¨ `immutable` ä¿®é¥°ç¬¦ï¼š

- éƒ¨ç½²æ—¶å†™å…¥ï¼Œè¿è¡Œæ—¶åªè¯»
- èŠ‚çœ SLOAD æ“ä½œçš„ Gas

### 2. å»¶è¿Ÿè®¡ç®—

- åˆ†æ•°åœ¨éœ€è¦æ—¶æ‰è®¡ç®—ï¼ˆ`calculateScores()`ï¼‰
- éªŒè¯ç»“æœæŒ‰éœ€ç”Ÿæˆï¼ˆ`_prepareVerifyResultIfNeeded()`ï¼‰
- å¥–åŠ±æŒ‰éœ€å‡†å¤‡ï¼ˆ`_prepareRewardIfNeeded()`ï¼‰

### 3. æ‰¹é‡æ“ä½œ

- `calculateScores()` ä¸€æ¬¡è®¡ç®—æ‰€æœ‰è´¦æˆ·
- é¿å…å¤šæ¬¡éå† `_accounts` æ•°ç»„

### 4. æ˜ å°„ä¼˜åŒ–

- ä½¿ç”¨ `mapping` å¿«é€ŸæŸ¥æ‰¾ï¼ˆO(1)ï¼‰
- é¿å…å¤§æ•°ç»„éå†

## å®‰å…¨æ¶æ„

### è®¿é—®æ§åˆ¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           æƒé™å±‚çº§                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚  Center (æœ€é«˜æƒé™)                       â”‚
â”‚   â”‚                                      â”‚
â”‚   â”œâ”€â†’ initialize()                      â”‚
â”‚   â””â”€â†’ addAccount() / removeAccount()    â”‚
â”‚                                          â”‚
â”‚  Factory (åˆ›å»ºæƒé™)                      â”‚
â”‚   â”‚                                      â”‚
â”‚   â””â”€â†’ åˆ›å»ºæ‰©å±•å®ä¾‹                       â”‚
â”‚                                          â”‚
â”‚  User (ç”¨æˆ·æƒé™)                         â”‚
â”‚   â”‚                                      â”‚
â”‚   â”œâ”€â†’ join() / stake()                  â”‚
â”‚   â”œâ”€â†’ withdraw() / unstake()            â”‚
â”‚   â””â”€â†’ claimReward()                     â”‚
â”‚                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### çŠ¶æ€ä¿æŠ¤

1. **åˆå§‹åŒ–ä¿æŠ¤**

   - `initialized` æ ‡å¿—ä½
   - `onlyCenter` ä¿®é¥°ç¬¦

2. **é‡å…¥ä¿æŠ¤**

   - å…ˆæ›´æ–°çŠ¶æ€ï¼Œåè½¬è´¦
   - Checks-Effects-Interactions æ¨¡å¼

3. **åŒèŠ±ä¿æŠ¤**

   - `_claimedReward` è®°å½•
   - ç¦æ­¢é‡å¤é¢†å–

4. **æº¢å‡ºä¿æŠ¤**
   - Solidity 0.8.x å†…ç½®æº¢å‡ºæ£€æŸ¥
   - ä¸éœ€è¦ SafeMath

### éªŒè¯é“¾

```
ç”¨æˆ·æ“ä½œ
 â”‚
 â”œâ”€â†’ æƒé™éªŒè¯ (onlyCenter / msg.sender)
 â”‚
 â”œâ”€â†’ çŠ¶æ€éªŒè¯ (initialized, amounts)
 â”‚
 â”œâ”€â†’ ä¸šåŠ¡éªŒè¯ (minGovVotes, waitingPeriod)
 â”‚
 â”œâ”€â†’ æ‰§è¡Œæ“ä½œ
 â”‚
 â””â”€â†’ è§¦å‘äº‹ä»¶
```

## æ‰©å±•æ€§è®¾è®¡

### æ¨ªå‘æ‰©å±•

æ·»åŠ æ–°çš„å‚ä¸æœºåˆ¶ï¼š

```
AutoScore
    â”œâ”€ Join (å·²å®ç°)
    â”œâ”€ Stake (å·²å®ç°)
    â””â”€ [Your Custom Mechanism] (å¯æ‰©å±•)
```

### çºµå‘æ‰©å±•

åœ¨ç°æœ‰æœºåˆ¶ä¸Šæ·»åŠ ç‰¹å®šé€»è¾‘ï¼š

```
Stake
    â””â”€ [Your Custom Stake] (å¯æ‰©å±•)
```

### ç»„åˆæ‰©å±•

æ··åˆå¤šç§æœºåˆ¶ï¼š

```
Base
    â””â”€ Custom Extension
        â”œâ”€ å€Ÿç”¨ Join çš„ç­‰å¾…æœŸæœºåˆ¶
        â””â”€ å€Ÿç”¨ AutoScore çš„åˆ†æ•°ç³»ç»Ÿ
```

## æ€§èƒ½è€ƒé‡

### æ—¶é—´å¤æ‚åº¦

| æ“ä½œ             | å¤æ‚åº¦ | è¯´æ˜                                |
| ---------------- | ------ | ----------------------------------- |
| join/stake       | O(1)   | å¸¸æ•°æ—¶é—´æ“ä½œ                        |
| withdraw/unstake | O(n)   | éœ€è¦ä»æ•°ç»„ä¸­ç§»é™¤ï¼Œn = accounts æ•°é‡ |
| calculateScores  | O(n)   | éå†æ‰€æœ‰è´¦æˆ·                        |
| claimReward      | O(1)   | åŸºäºæ˜ å°„æŸ¥æ‰¾                        |

### ç©ºé—´å¤æ‚åº¦

| æ•°æ®ç»“æ„                | ç©ºé—´ | å¢é•¿       |
| ----------------------- | ---- | ---------- |
| \_accounts              | O(n) | çº¿æ€§å¢é•¿   |
| \_scores[round]         | O(n) | æ¯è½® n     |
| \_scoreByAccount[round] | O(n) | æ¯è½® n     |
| \_reward                | O(r) | r = è½®æ¬¡æ•° |

### ä¼˜åŒ–å»ºè®®

1. **é™åˆ¶è´¦æˆ·æ•°é‡**ï¼šè€ƒè™‘è®¾ç½®æœ€å¤§å‚ä¸äººæ•°
2. **å®šæœŸæ¸…ç†**ï¼šæ¸…ç†å†å²æ•°æ®ï¼ˆå¦‚æœä¸éœ€è¦ï¼‰
3. **æ‰¹é‡æŸ¥è¯¢**ï¼šå‰ç«¯æ‰¹é‡è¯»å–æ•°æ®ï¼Œå‡å°‘ RPC è°ƒç”¨
4. **äº‹ä»¶ç´¢å¼•**ï¼šä½¿ç”¨äº‹ä»¶è€ŒéçŠ¶æ€å˜é‡å­˜å‚¨å†å²

## æ€»ç»“

LOVE20 Extension ç³»ç»Ÿé‡‡ç”¨åˆ†å±‚æ¶æ„è®¾è®¡ï¼š

- **Base Layer**ï¼šæä¾›åŸºç¡€è®¾æ–½
- **Score Layer**ï¼šæä¾›å¥–åŠ±åˆ†é…ç®—æ³•
- **Mechanism Layer**ï¼šæä¾›å‚ä¸æ–¹å¼ï¼ˆJoin/Stakeï¼‰

æ¯ä¸€å±‚éƒ½å¯ä»¥ç‹¬ç«‹ç†è§£å’Œæ‰©å±•ï¼Œé™ä½äº†ç³»ç»Ÿå¤æ‚åº¦ï¼Œæé«˜äº†å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§ã€‚
